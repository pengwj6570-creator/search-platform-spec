# 企业搜索中台设计方案

## 1. 项目概述

### 1.1 目标
建设企业级搜索中台，为内部多个业务线提供统一的搜索能力，支持电商搜索和内容搜索两大核心场景。

### 1.2 核心特性
- 多业务线统一接入，租户隔离
- 多路召回（关键词+向量+热门）
- 可配置排序策略，业务线自定义
- 向量搜索支持语义搜索、以图搜图、个性化推荐
- 自助式元数据配置，零代码接入
- 准实时数据同步（秒级延迟）

### 1.3 服务范围
| 维度 | 需求 |
|------|------|
| 服务对象 | 内部多业务线 |
| 业务场景 | 电商搜索 + 内容搜索 |
| 数据规模 | 千万级 |
| 搜索引擎 | Elasticsearch / OpenSearch |
| 部署环境 | 私有云 |
| 实时性 | 准实时（秒级） |
| 数据源 | PostgreSQL / MySQL / Oracle / 文件 |
| 排序策略 | 可配置，业务线自定义 |
| 向量搜索 | 语义搜索、以图搜图、个性化推荐 |

---

## 2. 总体架构

### 2.1 分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                      业务层（多业务线）                       │
└─────────────────────────────┬───────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                     API 服务层                               │
│  - 统一搜索接口  - 多租户鉴权  - 请求路由  - 限流熔断        │
└─────────────────────────────┬───────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                     查询处理层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ 多路召回引擎  │  │  召回融合    │  │  精排引擎    │       │
│  │ - 向量召回   │  │  - 去重      │  │  - 多因子    │       │
│  │ - 关键词召回 │  │  - 归一化    │  │  - 个性化    │       │
│  │ - 热门召回   │  │  - RRF融合   │  │  - 规则干预  │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────┬───────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                     索引管理层                               │
│  - 混合索引（倒排+向量）  - 多租户隔离  - 生命周期管理      │
└─────────────────────────────┬───────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                     数据处理层                               │
│  - 数据清洗  - 字段映射  - 向量化处理  - UDF扩展            │
└─────────────────────────────┬───────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                     数据接入层                               │
│  - CDC采集  - 消息队列  - 全量同步  - 增量同步              │
└─────────────────────────────┬───────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                     数据源层                                 │
│    MySQL      PostgreSQL      Oracle      文件              │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 核心模块设计

### 3.1 数据接入层

**CDC 采集架构：**

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  数据源      │     │   CDC 层     │     │  消息队列    │
│ MySQL/PG    │────▶│ Debezium    │────▶│ Kafka       │
│ Oracle      │     │ Logminer    │     │             │
│ 文件         │     │ File Watcher│     │             │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                             │
                               ┌──────────────┼──────────────┐
                               │              │              │
                         ┌─────▼─────┐  ┌───▼────┐  ┌──────▼──────┐
                         │ 数据处理    │  │数据处理│  │ 索引同步    │
                         │ 清洗        │  │清洗    │  │ ES Writer  │
                         └─────┬──────┘  └────────┘  └──────┬──────┘
                               │                            │
                               │                    ┌───────▼────────┐
                               │                    │ ES/OS 集群     │
                               │                    │ (文档已索引)   │
                               │                    └────────────────┘
                               │
                               ▼
                    ┌──────────────────┐
                    │ 向量化队列        │
                    │ (异步/旁路)       │
                    └────────┬─────────┘
                               │
                    ┌──────────▼─────────┐
                    │ 向量化处理器        │
                    │ (定时扫描队列)      │
                    └──────────┬─────────┘
                               │
                    ┌──────────▼─────────┐
                    │ 向量化服务          │
                    │ (生成Embedding)    │
                    └──────────┬─────────┘
                               │
                    ┌──────────▼─────────┐
                    │ ES 更新 API         │
                    │ (更新向量字段)      │
                    └──────────┬─────────┘
                               │
                    ┌──────────▼─────────┐
                    │ ES/OS 集群         │
                    │ (文档含向量)       │
                    └────────────────────┘
```

**同步流程：**

1. **CDC 捕获变更** - Debezium 监听 binlog/logminer，实时推送变更事件
2. **消息队列缓冲** - Kafka 解耦，支持重放和削峰
3. **数据消费处理** - 数据清洗、标准化
4. **立即写入 ES** - 文档先索引（不包含向量），保证搜索可用性
5. **异步向量化** - 检测需要向量化的字段，加入向量化队列
6. **后台处理队列** - 定时处理器扫描队列，调用向量服务
7. **更新向量字段** - 使用 ES Update API 部分更新文档的向量字段

**旁路模式优势：**
- 向量化不阻塞数据同步流程
- 向量服务故障不影响文档索引
- 支持重试机制，提高向量化成功率

**文件导入：**
- 支持全量导入（离线任务）
- 支持增量文件监控（实时监听目录变化）

**一致性保障：**
- 幂等处理（相同变更不重复）
- 失败重试 + 死信队列
- 定时全量校验，补偿修复

---

### 3.2 向量化模块

**三种向量类型支持：**

| 场景 | 输入 | Embedding 方式 | 向量维度 |
|------|------|----------------|----------|
| **语义搜索** | 文本（标题、描述、内容） | 文本 Embedding 模型（BGE/GTE） | 768/1024 |
| **以图搜图** | 商品图片 | 视觉 Embedding 模型（CLIP/ResNet） | 512/768 |
| **个性化推荐** | 用户行为序列 | 用户向量（Item2Vec/序列模型） | 256/512 |

**异步向量化架构（旁路模式）：**

为避免向量化阻塞数据同步流程，采用旁路异步处理模式：

```
数据变更 → CDC事件 → DataProcessor
                      ↓
              ┌───────┴───────┐
              ↓               ↓
      立即写入OpenSearch   加入向量化队列
      (不包含向量字段)      (VectorizationQueue)
                              ↓
                      AsyncVectorizationProcessor
                      (定时扫描队列)
                              ↓
                      调用VectorService生成向量
                              ↓
                      更新OpenSearch文档向量字段
```

**字段组合向量化：**

支持将多个字段组合后生成单个向量，提升语义匹配质量：

```yaml
# 配置示例：将标题和描述组合生成向量
fields:
  - name: "title"
    type: TEXT
    searchable: true

  - name: "description"
    type: TEXT
    searchable: true

  # 组合向量化配置
  - name: "combined_vector"
    type: DENSE_VECTOR
    vectorize: true
    vectorSourceFields: ["title", "description"]  # 源字段组合
    vectorTargetField: "combined_vector"          # 目标向量字段
    vectorDim: 768
```

**模块设计：**
- 文本向量化服务：BERT/GTE 系列
- 图片向量化服务：CLIP/VisualBERT
- 用户向量化服务：基于用户行为实时训练
- 统一的向量生成接口，支持异步和同步两种模式
- 向量存储：ES `dense_vector` 字段，支持多向量字段共存
- **异步向量化队列**：内存队列（生产环境建议使用 Kafka/Redis）
- **字段组合配置**：`vectorSourceFields` 支持多字段组合

---

### 3.3 多路召回引擎

**召回策略并发执行：**

```
                     ┌─────────────────┐
                     │   用户查询      │
                     └────────┬────────┘
                              │
                ┌─────────────┼─────────────┐
                │             │             │
        ┌───────▼──────┐ ┌───▼────┐ ┌─────▼──────┐
        │  向量召回    │ │ 关键词 │ │  其他召回  │
        │  (语义搜索)  │ │ 召回   │ │ (热门/类目)│
        └───────┬──────┘ └───┬────┘ └─────┬──────┘
                │             │             │
                └─────────────┼─────────────┘
                              │
                    ┌─────────▼─────────┐
                    │    召回融合       │
                    │  (去重+归一化)    │
                    └─────────┬─────────┘
                              │
                    ┌─────────▼─────────┐
                    │    精排引擎       │
                    │  (复杂排序策略)   │
                    └───────────────────┘
```

**各召回通道详细设计：**

| 召回通道 | 检索方式 | 候选数 | 适用场景 |
|---------|---------|--------|----------|
| **向量召回** | ANN 近似邻居 | 100-500 | 语义匹配、意图理解 |
| **关键词召回** | 倒排索引 | 200-1000 | 精确匹配、高频词 |
| **热门召回** | 预热缓存 | 50-200 | 无结果兜底、冷启动 |
| **类目召回** | 类目筛选 | 100-300 | 类目导航场景 |

**召回融合策略：**

1. **去重** - 同一文档多路召回去重
2. **归一化** - 各路召回分数归一化到 [0,1]
3. **融合方式**：
   - 加权融合：`score = α·向量 + β·关键词 + γ·热门`
   - RRF（Reciprocal Rank Fusion）：排序位置融合
   - 可配置融合策略

---

### 3.4 精排引擎

**可配置排序策略：**

```
score = w1 * relevance + w2 * sales + w3 * freshness +
        w4 * price_score + w5 * semantic_sim + w6 * personalized_boost
```

**配置能力：**
- 多因子加权配置（各业务线独立配置）
- 动态权重调整（支持 A/B 测试）
- 自定义评分函数（Script 支持）
- 个性化排序（基于用户向量的 boost）

**实现方式：**
- 配置中心存储排序规则
- 查询时动态构建 ES DSL
- 支持规则版本管理和灰度

---

### 3.5 元数据配置模块

**配置层级结构：**

```
来源系统 (Source)
    └── 搜索对象 (Object)
            └── 字段配置 (Field)
```

**配置示例：**

```yaml
# 来源系统定义
sources:
  - source_id: "mysql_ecommerce"
    source_type: "mysql"
    connection: "${MYSQL_ECOMMERCE_URL}"

  - source_id: "pg_content"
    source_type: "postgresql"
    connection: "${PG_CONTENT_URL}"

# 搜索对象定义
objects:
  - object_id: "product"
    source: "mysql_ecommerce"
    table: "products"
    primary_key: "id"

    # 字段配置
    fields:
      - name: "id"
        type: "long"
        es_mapping: '{"type": "integer"}'

      - name: "title"
        type: "text"
        searchable: true
        analyzer: "ik_max_word"
        vectorize: true
        vector_dim: 768

      - name: "price"
        type: "double"
        filterable: true
        sortable: true
```

**配置能力：**

| 配置项 | 说明 | 可选值 |
|--------|------|--------|
| `searchable` | 是否可搜索 | true/false |
| `filterable` | 是否可筛选 | true/false |
| `sortable` | 是否可排序 | true/false |
| `analyzer` | 分词器 | ik_max_word, ik_smart, standard |
| `vectorize` | 是否向量化 | true/false |
| `vectorType` | 向量类型 | text/image |
| `vectorDim` | 向量维度 | 256/512/768/1024 |
| `vectorSourceFields` | 向量源字段（组合） | ["title", "description"] |
| `vectorTargetField` | 向量目标字段名 | "combined_vector" |
| `boost` | 搜索权重 | 1.0-10.0 |

**动态配置流程（业务方自助）：**

```
1. 业务方登录管理后台
   │
2. 添加来源系统
   │   - 选择类型：MySQL / PostgreSQL / Oracle / 文件
   │   - 配置连接信息（加密存储）
   │   - 测试连接
   │
3. 创建搜索对象
   │   - 选择来源系统
   │   - 选择表/文件
   │   - 配置主键
   │
4. 配置搜索字段
   │   - 勾选需要索引的字段
   │   - 设置字段属性（搜索/筛选/排序）
   │   - 选择分词器
   │   - 勾选是否向量化
   │
5. 保存并生效
   │   - 自动创建 ES 索引
   │   - 自动创建同步任务
   │   - 首次全量同步
   │   - 增量实时同步
   │
6. 测试验证
   │   - 搜索测试页面
   │   - 验证结果符合预期
   │
7. 获取接入凭证
   │   - 分配 AppKey/AppSecret
   │   - 查看调用文档
```

**关键特性：**

| 能力 | 说明 |
|------|------|
| **零代码接入** | 业务方自助配置，无需开发 |
| **即时生效** | 配置保存后自动创建索引和同步任务 |
| **连接测试** | 配置来源时可测试连接是否正常 |
| **预览功能** | 配置后可预览生成的 ES Mapping |
| **沙盒测试** | 独立测试环境验证搜索效果 |
| **版本管理** | 配置变更历史，支持对比和回滚 |

---

### 3.6 API 服务层

**统一搜索接口：**

```json
POST /api/v1/search
{
  "query": "运动鞋",
  "app_key": "biz_ecommerce",

  // 召回策略控制
  "recall_strategy": {
    "keyword": true,
    "vector": {
      "enabled": true,
      "weight": 0.3,
      "k": 100
    },
    "hot": true,
    "category_filter": { }
  },

  // 其他参数
  "filters": { "price": { "gte": 100 } },
  "sort": { "field": "sales", "order": "desc" },
  "page": 1,
  "page_size": 20
}
```

**查询路由逻辑：**

| 参数组合 | 执行路径 | 场景 |
|---------|---------|------|
| `vector.enabled=false` | 仅关键词召回 | 传统搜索，低成本 |
| `vector.enabled=true` | 关键词 + 向量融合 | 语义增强搜索 |
| `keyword=false, vector=true` | 纯向量召回 | 纯语义搜索 |
| `keyword=false, vector=false` | 仅热门/类目召回 | 兜底场景 |

---

## 4. 部署架构

### 4.1 私有云部署

```
                    ┌──────────────────────────────────────┐
                    │            负载均衡 (SLB/Nginx)      │
                    └───────────────────┬──────────────────┘
                                        │
                    ┌───────────────────▼──────────────────┐
                    │          API 网关 (鉴权/限流)        │
                    └───────────────────┬──────────────────┘
                                        │
        ┌───────────────────────────────┼───────────────────────┐
        │                               │                       │
┌───────▼────────┐            ┌────────▼────────┐    ┌────────▼────────┐
│  查询服务集群   │            │  数据处理集群    │    │  向量化服务集群  │
│  (Stateless)   │            │  (Flink/Spark)  │    │  (GPU/CPU)      │
│  3-5 节点      │            │  2-3 节点       │    │  2-4 节点       │
└───────┬────────┘            └─────────────────┘    └─────────────────┘
        │
┌───────▼────────┐            ┌─────────────────┐    ┌─────────────────┐
│ ES/OpenSearch  │            │   Kafka 集群     │    │   配置中心       │
│   数据集群      │            │   3 节点        │    │   (Nacos/ETCD)  │
│   3-5 节点      │            └─────────────────┘    └─────────────────┘
│  (数据+主节点)  │
└────────────────┘            ┌─────────────────┐    ┌─────────────────┐
                              │   CDC 采集器     │    │   监控告警       │
                              │   2-3 节点       │    │   (Prometheus)  │
                              └─────────────────┘    └─────────────────┘
```

### 4.2 组件规划

| 组件 | 部署规模 | 说明 |
|------|---------|------|
| API 网关 | 2 节点 | 鉴权、限流、路由 |
| 查询服务 | 3-5 节点 | 无状态，可弹性扩展 |
| 数据处理 | 2-3 节点 | Flink/Spark 消费 Kafka |
| 向量化服务 | 2-4 节点 | Embedding 模型推理 |
| ES/OS 集群 | 3-5 节点 | 数据节点 + 协调节点 |
| Kafka | 3 节点 | 数据流缓冲 |
| CDC 采集器 | 2-3 节点 | 数据源变更捕获 |

---

## 5. 监控告警

### 5.1 监控指标体系

**查询监控：**

| 指标 | 说明 | 告警阈值 |
|------|------|---------|
| QPS | 每秒查询数 | 业务基线 |
| 响应时间 P99 | 99分位延迟 | > 500ms |
| 响应时间 P50 | 中位延迟 | > 100ms |
| 空结果率 | 无结果占比 | > 10% |
| 错误率 | 接口错误率 | > 1% |

**同步监控：**

| 指标 | 说明 | 告警阈值 |
|------|------|---------|
| 同步延迟 | CDC → ES 延迟 | > 10s |
| 积压量 | Kafka 消费积压 | > 10000 |
| 向量化耗时 | Embedding 耗时 | > 1s |

**集群监控：**
- ES 集群健康（green/yellow/red）
- JVM 堆内存使用率 > 80%
- CPU/磁盘/网络 IO

### 5.2 安全设计

**鉴权与隔离：**
- AppKey/AppSecret 接口鉴权
- 索引命名空间隔离（跨业务线不可见）
- 操作审计日志（敏感操作记录）

**数据安全：**
- 敏感字段脱敏（手机号、身份证）
- 传输加密（HTTPS）
- 支持字段级权限控制

---

## 6. 扩展能力

### 6.1 A/B 测试框架
- 支持不同算法策略分流对比
- 实验效果报表

### 6.2 配置管理
- 分词器配置（IK/jieba 等）
- 同义词词典
- 停用词管理
- 排序规则热更新

---

## 7. 技术选型建议

| 组件 | 推荐方案 | 备选方案 |
|------|---------|---------|
| 搜索引擎 | OpenSearch | Elasticsearch |
| 消息队列 | Kafka | RocketMQ |
| 数据处理 | Flink | Spark Streaming |
| CDC 采集 | Debezium | Canal |
| 配置中心 | Nacos | ETCD/Consul |
| 监控 | Prometheus + Grafana | - |
| 向量化模型 | BGE/GTE (文本) | CLIP (图片) |

---

## 8. 实施建议

### 8.1 分阶段建设

**第一阶段：基础能力**
- ES 集群搭建
- 基本关键词搜索
- MySQL/PG 数据同步
- 简单排序配置

**第二阶段：增强能力**
- 向量搜索接入
- 多路召回融合
- Oracle/文件数据源
- 可配置排序引擎

**第三阶段：自助平台**
- 元数据配置管理后台
- 业务方自助接入
- 监控告警完善

### 8.2 技术风险评估

| 风险 | 影响 | 应对 |
|------|------|------|
| ES 集群稳定性 | 高 | 充分压测，规划容量 |
| 向量计算性能 | 中 | GPU 加速，异步处理 |
| 数据一致性 | 高 | 幂等设计，定期校验 |
| 同步延迟 | 中 | 监控告警，优化批处理 |
